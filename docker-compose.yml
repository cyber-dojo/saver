
version: '3.7'

volumes:
  one_k:
    external: true

services:

  saver_client:
    build:
      context: test/client
    user: nobody:nogroup
    image: cyberdojo/saver-client
    container_name: test-saver-client
    ports: [ "${CYBER_DOJO_SAVER_CLIENT_PORT}:${CYBER_DOJO_SAVER_CLIENT_PORT}" ]
    env_file: [ .env ]
    read_only: true
    restart: 'no'
    volumes: []
    tmpfs: /tmp
    depends_on:
      - saver
      - languages # for tests
      - exercises # for tests

  # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  saver:
    build:
      context: .
      args: [ COMMIT_SHA ]
    user: saver
    image: ${CYBER_DOJO_SAVER_IMAGE}
    container_name: test-saver-server
    env_file: [ .env ]
    read_only: true
    restart: 'no'
    volumes:
      - ./test/server:/app/test:ro
      - one_k:/one_k
    tmpfs:
      - /cyber-dojo:uid=19663,gid=65533
      - /tmp:uid=19663,gid=65533
    depends_on:
      - languages # for tests
      - exercises # for tests

  # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  languages:
    user: nobody:nogroup
    image: ${CYBER_DOJO_LANGUAGES_START_POINTS_IMAGE}:${CYBER_DOJO_LANGUAGES_START_POINTS_TAG}
    container_name: test-saver-languages
    ports: [ "${CYBER_DOJO_LANGUAGES_START_POINTS_PORT}:${CYBER_DOJO_LANGUAGES_START_POINTS_PORT}" ]
    read_only: true
    tmpfs: /tmp
    restart: 'no'

  # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  exercises:
    user: nobody:nogroup
    image: ${CYBER_DOJO_EXERCISES_START_POINTS_IMAGE}:${CYBER_DOJO_EXERCISES_START_POINTS_TAG}
    container_name: test-saver-exercises
    ports: [ "${CYBER_DOJO_EXERCISES_START_POINTS_PORT}:${CYBER_DOJO_EXERCISES_START_POINTS_PORT}" ]
    read_only: true
    tmpfs: /tmp
    restart: 'no'

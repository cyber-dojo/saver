version: '3.7'

volumes:
  one_k:
    external: true

services:

  saver_client:
    build:
      context: client
      args: [ COMMIT_SHA ]
    user: nobody:nogroup
    image: cyberdojo/saver-client
    container_name: test-saver-client
    env_file: [ .env ]
    read_only: true
    restart: 'no'
    volumes:
      - ./client/source:/app/source:ro
      - ./client/test:/app/test:ro
      - ./tmp:/app/tmp:rw
    tmpfs: /tmp
    depends_on:
      - custom-start-points
      - saver

  saver:
    build:
      context: .
      args: [ COMMIT_SHA ]
    user: saver
    image: ${CYBER_DOJO_SAVER_IMAGE}
    container_name: test-saver-server
    depends_on:
      - custom-start-points
    env_file: [ .env ]
    read_only: true
    restart: 'no'
    volumes:
      - ./app/source:/app/source:ro
      - ./app/test:/app/test:ro
      - ./tmp:/app/tmp:rw
      - one_k:/one_k:rw
    tmpfs:
      - /cyber-dojo:uid=19663,gid=65533
      - /tmp:uid=19663,gid=65533

